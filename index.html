<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Socket Location Test</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h3>Socket Location Test</h3>

  <label>JWT Token:</label><br>
  <input type="text" id="token" placeholder="Token kiriting" style="width: 300px;" /><br><br>

  <button onclick="connectSocket()">ğŸ”Œ Ulanish</button>
  <button onclick="sendLocation()">ğŸ“ Joylashuv Yuborish</button>

  <p id="status">Status: <b>Uzilmagan</b></p>
  <pre id="log" style="background:#eee; padding:10px;"></pre>

  <script>
    let socket;

    function log(message) {
      document.getElementById('log').textContent += message + "\n";
    }

    function connectSocket() {
      const token = document.getElementById('token').value;

      socket = io("https://suddocs.uz/location", {
        auth: {
          token: token
        }
      });

      socket.on("connect", () => {
        document.getElementById('status').innerHTML = "Status: <b style='color:green;'>Ulandi</b>";
        log("âœ… Ulandi: " + socket.id);
        socket.emit("getAllOnlineUsers");
      });

      socket.on("locationUpdateConfirmed", data => {
        log("ğŸ“ Location update confirmed:\n" + JSON.stringify(data, null, 2));
      });

      socket.on("onlineUsers", data => {
        log("ğŸ‘¥ Online users:\n" + JSON.stringify(data, null, 2));
      });

      socket.on("nearbyUsers", data => {
        log("ğŸ“¡ Nearby users:\n" + JSON.stringify(data, null, 2));
      });

      socket.on("locationUpdated", data => {
        log("ğŸ›°ï¸ Location updated (broadcast):\n" + JSON.stringify(data, null, 2));
      });

      socket.on("error", err => {
        log("âŒ Error:\n" + JSON.stringify(err));
        document.getElementById('status').innerHTML = "Status: <b style='color:red;'>Xatolik</b>";
      });

      socket.on("disconnect", () => {
        log("ğŸ”Œ Uzildi");
        document.getElementById('status').innerHTML = "Status: <b style='color:red;'>Uzildi</b>";
      });
    }

    function sendLocation() {
      if (!socket || !socket.connected) {
        log("âš ï¸ Avval ulanishingiz kerak!");
        return;
      }

      // Statik lokatsiya (test uchun)
      const locationData = {
        latitude: 41.311081,
        longitude: 69.240562,
        address: "Toshkent, Oâ€˜zbekiston"
      };

      socket.emit("updateLocation", locationData);
      log("ğŸ“¤ Yuborildi: " + JSON.stringify(locationData));
    }
  </script>
</body>
</html>
